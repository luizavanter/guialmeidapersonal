name: Deploy Backend

on:
  push:
    branches:
      - main
    paths:
      - 'apps/**'
      - 'config/**'
      - 'mix.exs'
      - 'mix.lock'
      - 'Dockerfile'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      skip_migrations:
        description: 'Skip database migrations'
        required: false
        default: false
        type: boolean

env:
  PROJECT_ID: guialmeidapersonal
  REGION: southamerica-east1
  SERVICE_NAME: ga-personal-api
  REPO_NAME: ga-personal
  IMAGE_NAME: backend

jobs:
  build-and-deploy:
    name: Build and Deploy Backend
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          token_format: access_token

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker "$REGION-docker.pkg.dev" --quiet

      - name: Generate image tag
        id: tag
        env:
          GIT_SHA: ${{ github.sha }}
        run: |
          SHORT_SHA=$(echo "$GIT_SHA" | cut -c1-7)
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          echo "tag=${SHORT_SHA}-${TIMESTAMP}" >> "$GITHUB_OUTPUT"
          echo "image=${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO_NAME}/${IMAGE_NAME}" >> "$GITHUB_OUTPUT"

      - name: Build Docker image
        env:
          IMAGE: ${{ steps.tag.outputs.image }}
          TAG: ${{ steps.tag.outputs.tag }}
        run: |
          docker build \
            --build-arg MIX_ENV=prod \
            --tag "${IMAGE}:${TAG}" \
            --tag "${IMAGE}:latest" \
            --cache-from "${IMAGE}:latest" \
            .

      - name: Push Docker image
        env:
          IMAGE: ${{ steps.tag.outputs.image }}
          TAG: ${{ steps.tag.outputs.tag }}
        run: |
          docker push "${IMAGE}:${TAG}"
          docker push "${IMAGE}:latest"

      - name: Run database migrations
        if: ${{ github.event.inputs.skip_migrations != 'true' }}
        run: |
          echo "Running database migrations..."
          gcloud run jobs execute ga-personal-migrations \
            --project="$PROJECT_ID" \
            --region="$REGION" \
            --wait \
            || echo "Migration job may not exist yet, skipping..."

      - name: Deploy to Cloud Run
        id: deploy
        env:
          IMAGE: ${{ steps.tag.outputs.image }}
          TAG: ${{ steps.tag.outputs.tag }}
        run: |
          gcloud run deploy "$SERVICE_NAME" \
            --project="$PROJECT_ID" \
            --region="$REGION" \
            --image="${IMAGE}:${TAG}" \
            --platform=managed \
            --allow-unauthenticated \
            --quiet

      - name: Get service URL
        id: service
        run: |
          URL=$(gcloud run services describe "$SERVICE_NAME" \
            --project="$PROJECT_ID" \
            --region="$REGION" \
            --format='value(status.url)')
          echo "url=${URL}" >> "$GITHUB_OUTPUT"

      - name: Verify deployment
        env:
          SERVICE_URL: ${{ steps.service.outputs.url }}
        run: |
          echo "Service URL: $SERVICE_URL"
          echo "Testing health endpoint..."

          # Wait for service to be ready
          sleep 10

          # Test health endpoint
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${SERVICE_URL}/api/v1/health" || echo "000")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "Health check passed!"
          else
            echo "Warning: Health check returned status $HTTP_STATUS"
          fi

      - name: Deployment summary
        env:
          IMAGE: ${{ steps.tag.outputs.image }}
          TAG: ${{ steps.tag.outputs.tag }}
          SERVICE_URL: ${{ steps.service.outputs.url }}
          GIT_SHA: ${{ github.sha }}
        run: |
          {
            echo "## Deployment Summary"
            echo ""
            echo "- **Service:** $SERVICE_NAME"
            echo "- **Region:** $REGION"
            echo "- **Image:** ${IMAGE}:${TAG}"
            echo "- **URL:** $SERVICE_URL"
            echo "- **Commit:** $GIT_SHA"
          } >> "$GITHUB_STEP_SUMMARY"
